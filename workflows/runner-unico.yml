name: Runner Unico (Mercado AR)

on:
  schedule:
    - cron: "*/5 * * 1-5"
  workflow_dispatch: {}

concurrency:
  group: runner-unico
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  run:
    runs-on: ubuntu-latest
    if: ${{ github.actor != 'github-actions[bot]' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Market hour gate (AR)
        id: market
        shell: bash
        run: |
          HOUR_MIN=$(TZ=America/Argentina/Buenos_Aires date +%H%M)
          echo "Hora local AR: $(TZ=America/Argentina/Buenos_Aires date)"
          if [[ "$HOUR_MIN" -ge "1100" && "$HOUR_MIN" -lt "1730" ]]; then
            echo "open=true" >> "$GITHUB_OUTPUT"
          else
            echo "open=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip outside market hours
        if: ${{ steps.market.outputs.open == 'false' }}
        run: |
          echo "Fuera de horario â†’ fin."
          exit 0

      - name: Setup Python
        if: ${{ steps.market.outputs.open == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (if any)
        if: ${{ steps.market.outputs.open == 'true' }}
        run: |
          if [ -f requirements.txt ]; then
            pip install -U pip
            pip install -r requirements.txt
          fi

      - name: Run script
        if: ${{ steps.market.outputs.open == 'true' }}
        run: |
          python run.py
